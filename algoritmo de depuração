import pandas as pd
import shutil
import numpy as np

# Definindo as listas necessárias para a troca dos headers do Data Frame

cabecalhos = ["ns1:cNF", "ns1:natOp", "ns1:dhEmi",
              "ns1:xMun9", "ns1:UF10", "ns1:uCom", "ns1:qCom", "ns1:cProd", "ns1:vProd", "ns1:vFrete", "ns1:vDesc",
              "ns1:vNF", "ns1:infCpl"]
novos_cabecalhos = ["NF", "Natureza da Operação", "Data",
                    "Município", "UF", "Descrição de qtde", "Quantidade comprada", "Produto", "Valor", "Frete",
                    "Desconto",
                    "Total", "Complementar"]
cab = ["ns1:cNF","ns1:xProd", "ns1:cProd", "ns1:dhEmi", "ns1:qCom"]
new_cab = ["NF", "Data", "Código", "Produto", "Quantidade comprada"]

# Puxando os arquivos necessários pra operação

arquivo1 = pd.read_excel(r"C:\Users\User\Desktop\Trabalho\MAP\MAP\NB Store\Consolidado NB\Consolidado NB original.xlsx", usecols=cabecalhos)
df1 = pd.DataFrame(arquivo1)
arquivo2 = pd.read_excel(r"C:\Users\User\Desktop\Trabalho\MAP\Python\Planilha secundária.xlsx")
df2 = pd.DataFrame(arquivo2)
arquivo3 = pd.read_excel(r"C:\Users\User\Desktop\Trabalho\MAP\MAP\NB Store\Consolidado NB\Consolidado NB original.xlsx", usecols=cab)
df3 = pd.DataFrame(arquivo3)

#    Passando funções de limpeza dos dados pra todos os dataframes (remoção
# de redundâncias e valores nulos, repassando os novos cabeçalhos, etc)

df1.dropna()
df1.columns = novos_cabecalhos
df1.drop_duplicates(subset="Complementar", keep="last", inplace=True)
df1.replace(np.nan, 0)

df3 = df3.dropna()
df3.columns = new_cab

# Fazendo a fusão dos dataframes

m = pd.merge(df1, df2, how='outer', on='Data')

# Definindo variáveis para a depuração das colunas onde há o código da loja que iremos precisar

cod = []
L = [12, 13]
col2 = m.iloc[:, L]

# Passando a coluna "Complementar" para o laço de repetição que irá obter os códigos

for item in col2["Complementar"]:
    string = str(item)                          # Converte o obj em string
    sliced = string.split("Loja: ")[::-1]       # Divide a string EXATAMENTE NO PONTO onde está o código
    codigo = sliced[0]                          # Variável já com a substring atribuída
    if codigo[0:4] == "Loja":
        cod.append("Americanas")
    elif codigo[0:4] == "Subm":
        cod.append("Americanas")
    elif codigo[0:4] == "Shop":
        cod.append("Americanas")
    elif codigo[0:2] == "22":
        cod.append("Shopee")
    elif codigo[0] == "9":
        cod.append("Netshoes")
    elif codigo[0:4] == "2000":
        cod.append("Integra")
    else:
        cod.append("0")

#    Passando as funções que irão converter a lista em um objeto dataframe e irão fazer a substituição
# dos valores na coluna "Loja2" pelos da coluna "Loja"

cod = pd.DataFrame(cod)
m["Loja2"] = cod
m = m.drop(columns=['Complementar', "Total_y"])
m.loc[m["Loja2"] == "0", "Loja2"] = m["Loja"]

# Salvamento das planilhas

m.to_excel("Consolidado NB tratado.xlsx")
df3.to_excel("Consolidado produtos NB.xlsx")

#    Salvamento feito, último passo é definir variáveis origem e destino pra mudança de pasta
# e, logicamente, mover os arquivos.

source_1 = r'C:\Users\User\Desktop\Trabalho\MAP\Python\venv\Consolidado NB tratado.xlsx'
destination_1 = r"C:\Users\User\Desktop\Trabalho\MAP\MAP\NB Store\Consolidado NB\Consolidado NB tratado.xlsx"
source_2 = r'C:\Users\User\Desktop\Trabalho\MAP\Python\venv\Consolidado produtos NB.xlsx'
destination_2 = r"C:\Users\User\Desktop\Trabalho\MAP\MAP\NB Store\Consolidado NB\Consolidado produtos NB.xlsx"
shutil.move(source_1,destination_1)
shutil.move(source_2,destination_2)
